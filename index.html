<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>P2: Justina Chen (jjc382), Sofie Cornelis (sac338), Jungsoo Lee (jl3329)</title>
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Alegreya|Alegreya+Sans" rel="stylesheet">
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/styles/default.min.css">
    <link href="css/styles.css" rel="stylesheet">
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <script src="http://d3js.org/topojson.v2.min.js"></script>
    <script src="https://d3js.org/d3-array.v1.min.js"></script>
    <script src="https://d3js.org/d3-geo.v1.min.js"></script>
    <script src="https://d3js.org/d3-geo-projection.v1.min.js"></script>
  </head>
  <body>
  <div class = "container">
    <div class = "row text-centered">
        <div class = "col-lg-12 col-md-12 col-s-12 col-xs-12">
          <h1>Crime and Unemployment by: in New York State</h1>
          <h4>Justina Chen (jjc382), Sofie Cornelis (sac338), Jungsoo Lee (jl3329)</h4>
        </div>
        <div class = "col-lg-12 col-md-12 col-s-12 col-xs-12 top-buffer">
        <p><b>Project Description: </b>Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.</p>
        </div>
    </div>
    <div class = "row top-buffer">
        <div class = "col-lg-12 col-md-12 col-s-12 col-xs-12 text-centered">
            <h4><span class = "right-buffer">Types of Crime:</span> 
                <div class="btn-group" role="group">
                  <button type="button" class="btn btn-secondary">Murder</button>
                  <button type="button" class="btn btn-secondary">Rape</button>
                  <button type="button" class="btn btn-secondary">Robbery</button>
                  <button type="button" class="btn btn-secondary">Aggravated Assault</button>
                  <button type="button" class="btn btn-secondary">Burglary</button>
                  <button type="button" class="btn btn-secondary">Larceny</button>
                  <button type="button" class="btn btn-secondary">Motor Vehicle Theft</button>
                </div>
            </h4>
        </div>
        <div class = "col-lg-5 col-md-5 col-s-12 col-xs-12">
            <h3>Histogram</h3>
            <svg id = "svgGraph">
                
            </svg>
        </div>
        <div class = "col-lg-7 col-md-7 col-s-12 col-xs-12">
            <h3>NY State Map by:</h3>
            <svg id = "svgState">
                
            </svg>
            <h3>NY Metro Area</h3>
            <svg id = "svgMetro">
                
            </svg>
        </div>
    </div>
  </div>

  <script>
    var svgState = d3.select("#svgState");

    var projection = d3.geoMercator().scale(4200).center([-73.6, 42.88]);
    var nyCounties;
    var crimeData, unemploymentData;
    var centroids;
    var fips_to_county = {
        36001: 'Albany', 
        36003: 'Allegany', 
        36005: 'Bronx',
        36007: 'Broome',
        36009: 'Cattaraugus',
        36011: 'Cayuga',
        36013: 'Chautauqua',
        36015: 'Chemung',
        36017: 'Chenango',
        36019: 'Clinton',
        36021: 'Columbia',
        36023: 'Cortland',
        36025: 'Delaware',
        36027: 'Dutchess',
        36029: 'Erie',
        36031: 'Essex',
        36033: 'Franklin',
        36035: 'Fulton',
        36037: 'Genesee',
        36039: 'Greene',
        36041: 'Hamilton',
        36043: 'Herkimer',
        36045: 'Jefferson',
        36047: 'Kings',
        36049: 'Lewis',
        36051: 'Livingston',
        36053: 'Madison',
        36055: 'Monroe',
        36057: 'Montgomery',
        36059: 'Nassau',
        36061: 'New York',
        36063: 'Niagara',
        36065: 'Oneida',
        36067: 'Onondaga',
        36069: 'Ontario',
        36071: 'Orange',
        36073: 'Orleans',
        36075: 'Oswego',
        36077: 'Otsego',
        36079: 'Putnam',
        36081: 'Queens',
        36083: 'Rensselaer',
        36085: 'Richmond',
        36087: 'Rockland',
        36089: 'St Lawrence',
        36091: 'Saratoga',
        36093: 'Schenectady',
        36095: 'Schoharie',
        36097: 'Schuyler',
        36099: 'Seneca',
        36101: 'Steuben',
        36103: 'Suffolk',
        36105: 'Sullivan',
        36107: 'Tioga',
        36109: 'Tompkins',
        36111: 'Ulster',
        36113: 'Warren',
        36115: 'Washington',
        36117: 'Wayne',
        36119: 'Westchester',
        36121: 'Wyoming',
        36123: 'Yates'      }

    d3.queue()
    .defer(d3.json, "us.json")
    .defer(d3.csv, "cleaned_crime.csv")
    .defer(d3.csv, "cleaned_unemployment.csv")
    .await(function(error, rawMap, cleaned_crime, unemployment) {
      //-----------------MAP--------------------------
      counties = topojson.feature(rawMap, rawMap.objects.counties);
      nyCounties = []
      counties.features.forEach(function (county){
        if (parseInt(county.id/1000)==36){
          nyCounties.push(county)
        }
      })
      unemploymentData = d3.nest().key(function(d) {
        return d.County;
      }).entries(unemployment);

      var unemployment_by_county = {};
      unemploymentData.forEach(function (region) {
          var years = region.values;
          var rate = 0.0;
          years.forEach(function (year) {
            if(year["Year"] = "2016"){
              rate = Number(year["UnemploymentRate"]);
            }
          });
          unemployment_by_county[region.key] = rate;
      });

      showState(svgState, unemployment_by_county);

      //-----------------SCATTER PLOT--------------------------
      // nest cleaned_crime by county "Albany"
      crimeData = d3.nest().key(function(d) {
        return d.County;
      }).entries(cleaned_crime);
      // nest cleaned_crime by area "Albany':" 
      


      // var crimes;
      // console.log(crimeData);
      // temp = crimeData[0].values[0];
      // crimes = d3.map(temp, function(v, i){
      //   return i;
      // });
      // crimes = crimes.slice(2)  // ignore county, year, total
      scatterplotCrime("#svgGraph", "Albany", "Murder");
      createCrimeCircles("#svgState", "Murder")
    });

    //---------------------------------------------
    //-----------------MAP--------------------------
    //---------------------------------------------

    function showState(svg_id, unemployment_by_county) {
      var pathGenerator = d3.geoPath().projection(projection);

      centroids = nyCounties.map(function (county) {
        return { id:county.id, centroid:pathGenerator.centroid(county) };
      });

      var unemployment_domain = d3.extent(Object.keys(fips_to_county), function (county) {
        var county_name = fips_to_county[county] + ' County'
        return unemployment_by_county[county_name];
      });

      var unemployment_scale = d3.scaleLinear().domain(unemployment_domain)
          .range(['#e0ecf4','#8856a7']);

      var paths = svg_id.selectAll("path.country").data(nyCounties);
      paths.enter().append("path").attr("class", "country")
        .attr("id", function (county) {
          return county.id;
        })
        // .on("click", function (d) { console.log(d.id); })
        .merge(paths)
        .style("fill", function(county){
          var county_name = fips_to_county[county.id] + ' County';
          var rate = unemployment_by_county[county_name];

          //this doesnt change anything yet, should make St. Lawrence county not black
          if(fips_to_county[county.id] == '36089') {return unemployment_scale(0.06579453636013852);}
          else {return unemployment_scale(rate);}
        })
        .attr("d", function(county) {
          return pathGenerator(county);
        });
    }
    
    //-------------------------------------------------------
    //-----------------SCATTER PLOT--------------------------
    //-------------------------------------------------------
    function scatterplotCrime(svg_id, county, crime){
      var svg = d3.select(svg_id);
      var padding = 50;
      var svg_width = parseInt(svg.style("width"));

      var arr = [];
      var yVals = [];
      var xVals = [];
      
      crimeData.forEach(function(d){
        if (d.key == county){ // objects for specified county
          d.values.forEach(function(c){
            arr.push({CrimeInstances: c[crime], Year:c.Year})   // get instances of that crime and year
            yVals.push(c[crime]);
          })
        }
      })

      unemploymentData.forEach(function(d){
        if (d.key == county + "':"){ // "Albany':"
          console.log("found county");
          d.values.forEach(function(c){
          // get matching object in arr
            var point = arr.filter(function( obj ) {
              return obj.Year == c.Year;
            });
            if (point.length > 0){
              point[0].Unemployment = c.UnemploymentRate;
              xVals.push(c.UnemploymentRate);
            }

          })
        }
      })
      console.log(arr);

      var xScale = d3.scaleLinear()
      .domain([d3.min(xVals), d3.max(xVals)])
      .range([padding, svg_width - padding]);

      var yScale = d3.scaleLinear()
        .domain([d3.min(yVals), d3.max(yVals)])
        .range([svg_width - padding, padding])

      var xAxis = d3.axisBottom(xScale).ticks(10, ".01f")
      .tickSizeOuter(0);
      svg.append("g").attr("transform", "translate(0,"+(svg_width-padding+5).toString()+")").call(xAxis);

      var yAxis = d3.axisLeft(yScale).ticks(10, "s")
      .tickSizeOuter(0);
      svg.append("g").attr("transform", "translate(" + (svg_width-padding-5).toString()+ "0)").call(yAxis);

    };

    // Crime Circles
    function createCrimeCircles(svg_id, crime_type) {
      var svg = d3.select(svg_id);

      var crimes_by_county = {};
      crimeData.forEach(function (d) {
        var total = 0;
        var years = d.values;
        years.forEach(function (year) {
          total += parseInt(year[crime_type]);
        });
        crimes_by_county[d.key] = total;
      });

      var crimeDomain = d3.extent(Object.keys(crimes_by_county), function (county) {
        return crimes_by_county[county];
      });

      var size = d3.scaleLinear()
        .domain(crimeDomain)
        .range([1, 10]);

      var circles = svg.selectAll("circle").data(centroids);
      circles.enter().append("circle")
        .attr("cx", function (d) {
          return d.centroid[0]; 
        })
        .attr("cy", function (d) {
          return d.centroid[1];
        })
        .attr("r", function (d) {
          var county = fips_to_county[d.id];
          var instances = crimes_by_county[county];
          return size(instances);
        });
    }

    </script>


    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <script src="js/bootstrap.min.js"></script>
  </body>
</html>